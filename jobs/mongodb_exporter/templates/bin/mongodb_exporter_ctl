#!/usr/bin/env bash

set -eu

RUN_DIR=/var/vcap/sys/run/mongodb_exporter
LOG_DIR=/var/vcap/sys/log/mongodb_exporter
TMP_DIR=/var/vcap/sys/tmp/mongodb_exporter
STORE_DIR=/var/vcap/store/mongodb_exporter
mkdir -p ${RUN_DIR} ${LOG_DIR} ${TMP_DIR} ${STORE_DIR}

PIDFILE=${RUN_DIR}/mongodb_exporter.pid

source /var/vcap/packages/mongodb_exporter/common/utils.sh
exec 1>> ${LOG_DIR}/$(basename "$0").stdout.log
exec 2>> ${LOG_DIR}/$(basename "$0").stderr.log

export PATH=/var/vcap/packages/mongodb_exporter/bin:${PATH}

case $1 in
  start)
    pid_guard ${PIDFILE} "mongodb_exporter"
    echo $$ > ${PIDFILE}

    JOB_DIR=/var/vcap/jobs/mongodb_exporter

    exec mongodb_exporter \
      <% if_p('mongodb.user') do |mongodb_user| %> \
      --mongodb.user="<%= mongodb_user %>" \
      <% end %> \
      <% if_p('mongodb.password') do |mongodb_password| %> \
      --mongodb.password="<%= mongodb_password %>" \
      <% end %> \
      <% if_p('mongodb.collstats-colls') do |mongodb_collstats_colls| %> \
      --mongodb.collstats-colls="<%= mongodb_collstats_colls %>" \
      <% end %> \
      <% if_p('mongodb.indexstats-colls') do |mongodb_indexstats_colls| %> \
      --mongodb.indexstats-colls="<%= mongodb_indexstats_colls %>" \
      <% end %> \
      --mongodb.uri="<%= p('mongodb.uri') %>" \
      <% if_p('mongodb.global-conn-pool') do |mongodb_global_conn_pool| %> \
      --mongodb.global-conn-pool="<%= mongodb_global_conn_pool %>" \
      <% end %> \
      <% if_p('mongodb.direct-connect') do |mongodb_direct_connect| %> \
      --mongodb.direct-connect="<%= mongodb_direct_connect %>" \
      <% end %> \
      <% if_p('web.listen-address') do |web_listen_address| %> \
      --web.listen-address="<%= web_listen_address %>" \
      <% end %> \
      <% if_p('web.telemetry-path') do |web_telemetry_path| %> \
      --web.telemetry-path="<%= web_telemetry_path %>" \
      <% end %> \
      <% if_p('web.config') do |web_config| %> \
      --web.config="<%= web_config %>" \
      <% end %> \
      <% if_p('web.timeout-offset') do |web_timeout_offset| %> \
      --web.timeout-offset="<%= web_timeout_offset %>" \
      <% end %> \
      <% if_p('log.level') do |log_level| %> \
      --log.level="<%= log_level %>" \
      <% end %> \
      <% if_p('mongodb.connect-timeout-ms') do |mongodb_connect_timeout_ms| %> \
      --mongodb.connect-timeout-ms="<%= mongodb_connect_timeout_ms %>" \
      <% end %> \
      <% if_p('collector.exporter-metrics') do |collector_exporter_metrics| %> \
      --collector.exporter_metrics \
      <% end %> \
      <% if_p('collector.diagnosticdata') do |collector_diagnosticdata| %> \
      --collector.diagnosticdata \
      <% end %> \
      <% if_p('collector.replicasetstatus') do |collector_replicasetstatus| %> \
      --collector.replicasetstatus \
      <% end %> \
      <% if_p('collector.replicasetconfig') do |collector_replicasetconfig| %> \
      --collector.replicasetconfig \
      <% end %> \
      <% if_p('collector.dbstats') do |collector_dbstats| %> \
      --collector.dbstats \
      <% end %> \
      <% if_p('collector.dbstatsfreestorage') do |collector_dbstatsfreestorage| %> \
      --collector.dbstatsfreestorage="<%= collector_dbstatsfreestorage %>" \
      <% end %> \
      <% if_p('collector.topmetrics') do |collector_topmetrics| %> \
      --collector.topmetrics="<%= collector_topmetrics %>" \
      <% end %> \
      <% if_p('collector.currentopmetrics') do |collector_currentopmetrics| %> \
      --collector.currentopmetrics="<%= collector_currentopmetrics %>" \
      <% end %> \
      <% if_p('collector.indexstats') do |collector_indexstats| %> \
      --collector.indexstats="<%= collector_indexstats %>" \
      <% end %> \
      <% if_p('collector.collstats') do |collector_collstats| %> \
      --collector.collstats \
      <% end %> \
      <% if_p('collector.profile') do |collector_profile| %> \
      --collector.profile \
      <% end %> \
      <% if_p('collector.fcv') do |collector_fcv| %> \
      --collector.fcv \
      <% end %> \
      <% if_p('collector.shards') do |collector_shards| %> \
      --collector.shards \
      <% end %> \
      <% if_p('collector.pbm') do |collector_pbm| %> \
      --collector.pbm \
      <% end %> \
      <% if_p('metrics.overridedescendingindex') do |metrics_overridedescendingindex| %> \
      --metrics.overridedescendingindex \
      <% end %> \
      <% if_p('collect-all') do |collect_all| %> \
      --collect-all \
      <% end %> \
      <% if_p('collector.collstats-limit') do |collector_collstats_limit| %> \
      --collector.collstats-limit="<%= collector_collstats_limit %>" \
      <% end %> \
      <% if_p('collector.collstats-enable-details') do |collector_collstats_enable_details| %> \
      --collector.collstats-enable-details \
      <% end %> \
      <% if_p('collector.profile-time-ts') do |collector_profile_time_ts| %> \
      --collector.profile-time-ts="<%= collector_profile_time_ts %>" \
      <% end %> \
      <% if_p('collector.currentopmetrics-slow-time') do |collector_currentopmetrics_slow_time| %> \
      --collector.currentopmetrics-slow-time="<%= collector_currentopmetrics_slow_time %>" \
      <% end %> \
      <% if_p('discovering-mode') do |discovering_mode| %> \
      --discovering-mode \
      <% end %> \
      <% if_p('compatible-mode') do |compatible_mode| %> \
      --compatible-mode \
      <% end %> \
      <% if_p('version') do |version| %> \
      --version \
      <% end %> \
      <% if_p('split-cluster') do |split_cluster| %> \
      --split-cluster \
      <% end %> \
      >>  ${LOG_DIR}/mongodb_exporter.stdout.log \
      2>> ${LOG_DIR}/mongodb_exporter.stderr.log
    ;;

  stop)
    kill_and_wait ${PIDFILE}
    ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
    ;;

esac
exit 0