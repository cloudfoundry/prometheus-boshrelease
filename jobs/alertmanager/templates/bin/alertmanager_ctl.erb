#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the webapp_ctl script
source /var/vcap/jobs/alertmanager/helpers/ctl_setup.sh 'alertmanager'

export PORT=${PORT:-5000}
export LANG=en_US.UTF-8

ALERTMANAGER=/var/vcap/packages/alertmanager/alertmanager
CONFIG="-config.file=/var/vcap/jobs/alertmanager/config/alertmanager.conf"
SILENCES="-silences.file=/var/vcap/storage/alertmanager/silences.json"
LISTEN="-web.listen-address=:<%= p("alertmanager.port") %>"
REFRESH="-alerts.min-refresh-period=<%= p("alertmanager.min-refresh") %>"
BUFFER="-notification.buffer-size=<%= p("alertmanager.buffer-size") %>"
HIPCHAT="-notification.hipchat.url=<%= p("alertmanager.hipchat-url") %>"
PAGERDUTY="-notification.pagerduty.url=<%= p("alertmanager.pagerduty-url") %>"
SMTP="-notification.smtp.sender=<%= p("alertmanager.smtp-sender") %> -notification.smtp.smarthost=<%= p('alertmanager.smtp-smarthost') %>"
LOGLEVEL="-stderrthreshold=<%= p("alertmanager.log-level") %>"

OPTIONS="-logtostderr $CONFIG $SILENCES $LISTEN $REFRESH $BUFFER $HIPCHAT $PAGERDUTY $SMTP $LOGLEVEL"

case $1 in

  start)
    pid_guard $PIDFILE $JOB_NAME

    # store pid in $PIDFILE
    echo $$ > $PIDFILE

    exec chpst -u vcap:vcap $ALERTMANAGER $OPTIONS \
         >>$LOG_DIR/$JOB_NAME.stdout.log \
         2>>$LOG_DIR/$JOB_NAME.stderr.log

    ;;

  stop)
    kill_and_wait $PIDFILE

    ;;
  *)
    echo "Usage: alertmanager_ctl {start|stop}"

    ;;

esac
exit 0
